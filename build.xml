<?xml version="1.0"?>
<project xmlns="antlib:org.apache.tools.ant" basedir="." default="up" xmlns:if="ant:if" xmlns:unless="ant:unless" >
	<import file="antcc/main.xml" />
	
	<target name="up" depends="tuneup,credentials,masters,licenses,images,installers,mirrors" description="Setup everything" />

	<target name="proxy" depends="waitcc,sagenvInit" description="Configure proxy">
		<antcall target="apply">
			<param name="t" value="templates/cc-proxy" />
		</antcall>
		<antcall target="restartcc" />
	</target>

	<target name="tuneup" depends="waitcc,sagenvInit" description="Tune up Command Central">
		<antcall target="apply">
			<param name="t" value="templates/cc-tuneup" />
		</antcall>
		<antcall target="restartcc" />
	</target>	

	<target name="credentials" depends="sagenvInit" description="Configure credentials" >
		<!-- env vars have presedence over env.properties -->
		<property name="empower.username" value="${env.EMPOWER_USR}" if:set="env.EMPOWER_USR" />
		<property name="empower.password" value="${env.EMPOWER_PSW}" if:set="env.EMPOWER_PSW"/>

		<!-- load the from propertes file -->
		<property file="${env.properties}" />

		<!-- if stil don't have credentials, ask for them -->
		<echo unless:set="empower.password">
			Provide https://empower.softwareag.com/ Download Center credentials:
		</echo>

		<input message="Enter your https://empower.softwareag.com/ username (email address): " 
			addproperty="empower.username" unless:set="empower.username" />

		<input message="Enter your https://empower.softwareag.com/ password (will NOT be masked!): " 
			addproperty="empower.password" unless:set="empower.password"/>

		<mkdir dir="build" />
		<propertyfile file="build/.env.properties">
			<entry key="empower.username" value="${empower.username}" />
			<entry key="empower.password" value="${empower.password}" />
		</propertyfile>

		<echo>
			Securely store Empower credentials in Command Central ...
		</echo>

		<antcall target="apply">
			<param name="t" value="templates/cc-creds" />
			<param name="env.properties" value="build/.env.properties" />
		</antcall>
		<delete file="build/.env.properties" />

		<echo>
			List of configured credentials
		</echo>
		<cc command="list configuration instances nodeAlias=local runtimeComponentId=OSGI-CCE-ENGINE configurationTypeId=COMMON-CREDENTIALS refresh=true properties=id" format="tsv" />

	</target>

	<target name="masters" depends="waitcc,sagenvInit" description="Register master repositories">
		<antcall target="apply">
			<param name="t" value="templates/sag-repos" />
		</antcall>
	</target>

</project>
